#include <iostream>
#include <fstream>
#include <string>
#include <vector>
#include <filesystem>
#include <locale>

using namespace std;

// Структура "Автор"
struct Author {
    string name;
    string country;
};

// Структура "Книга"
struct Book {
    int id;
    string title;
    int year;
    Author author;
};

// -----------------------------
// Функция сохранения в JSON
// -----------------------------
void saveJSON(const vector<Book>& books)
{
    ofstream f("out/data.json", ios::out | ios::trunc);
    if (!f) {
        cerr << "Erreur d'ouverture du fichier JSON\n";
        return;
    }

    f << "[\n";
    for (size_t i = 0; i < books.size(); ++i) {
        f << " {\n";
        f << " \"id\": " << books[i].id << ",\n";
        f << " \"title\": \"" << books[i].title << "\",\n";
        f << " \"year\": " << books[i].year << ",\n";
        f << " \"author\": {\n";
        f << " \"name\": \"" << books[i].author.name << "\",\n";
        f << " \"country\": \"" << books[i].author.country << "\"\n";
        f << " }\n";
        f << " }";
        if (i < books.size() - 1) f << ",";
        f << "\n";
    }
    f << "]";
}

// -----------------------------
// Функция сохранения в CSV
// -----------------------------
void saveCSV(const vector<Book>& books)
{
    ofstream f("out/data.csv", ios::out | ios::trunc);
    if (!f) {
        cerr << "Erreur d'ouverture du fichier CSV\n";
        return;
    }

    f << "id,title,year,author_name,author_country\n";
    for (const auto& b : books) {
        f << b.id << ",";
        f << "\"" << b.title << "\",";
        f << b.year << ",";
        f << "\"" << b.author.name << "\",";
        f << "\"" << b.author.country << "\"\n";
    }
}

// -----------------------------
// Функция сохранения в XML
// -----------------------------
void saveXML(const vector<Book>& books)
{
    ofstream f("out/data.xml", ios::out | ios::trunc);
    if (!f) {
        cerr << "Erreur d'ouverture du fichier XML\n";
        return;
    }

    f << "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
    f << "<library>\n";
    for (const auto& b : books) {
        f << " <book>\n";
        f << " <id>" << b.id << "</id>\n";
        f << " <title>" << b.title << "</title>\n";
        f << " <year>" << b.year << "</year>\n";
        f << " <author>\n";
        f << " <name>" << b.author.name << "</name>\n";
        f << " <country>" << b.author.country << "</country>\n";
        f << " </author>\n";
        f << " </book>\n";
    }
    f << "</library>\n";
}

// -----------------------------
// Функция сохранения в YAML
// -----------------------------
void saveYAML(const vector<Book>& books)
{
    ofstream f("out/data.yaml", ios::out | ios::trunc);
    if (!f) {
        cerr << "Erreur d'ouverture du fichier YAML\n";
        return;
    }

    for (const auto& b : books) {
        f << "- id: " << b.id << "\n";
        f << "  title: " << b.title << "\n";
        f << "  year: " << b.year << "\n";
        f << "  author:\n";
        f << "    name: " << b.author.name << "\n";
        f << "    country: " << b.author.country << "\n";
    }
}

// -----------------------------
// Главная функция
// -----------------------------
int main()
{
    setlocale(LC_ALL, "Russian");

    // Тестовые данные (аналог таблицы book, связанной с author)
    vector<Book> books = {
        {1, "Война и мир", 1869, {"Лев Толстой", "Россия"}},
        {2, "Преступление и наказание", 1866, {"Фёдор Достоевский", "Россия"}},
        {3, "Отцы и дети", 1862, {"Иван Тургенев", "Россия"}}
    };

    // Создание папки out (проверка результата)
    if (!std::filesystem::create_directory("out")) {
        if (!std::filesystem::exists("out")) {
            cerr << "Impossible de créer le répertoire 'out'\n";
            return 1;
        }
    }

    // Сохранение данных в разные форматы
    saveJSON(books);
    saveCSV(books);
    saveXML(books);
    saveYAML(books);

    cout << "Файлы успешно созданы в папке 'out'!" << endl;
    return 0;
}

