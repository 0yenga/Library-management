/*
    ЛАБОРАТОРНАЯ РАБОТА №5
    Тема: Форматы данных (JSON, CSV, XML, YAML)
    Вариант: Учёт книг в библиотеке
*/

#include <iostream>
#include <fstream>
#include <string>
#include <vector>
#include <filesystem>
using namespace std;

// Структура "Автор"
struct Author {
    string name;
    string country;
};

// Структура "Книга"
struct Book {
    int id;
    string title;
    int year;
    Author author;
};

// -----------------------------
// Функция сохранения в JSON
// -----------------------------
void saveJSON(const vector<Book>& books) {
    ofstream f("out/data.json", ios::out | ios::trunc);
    f << "[\n";
    for (size_t i = 0; i < books.size(); ++i) {
        f << "  {\n";
        f << "    \"id\": " << books[i].id << ",\n";
        f << "    \"title\": \"" << books[i].title << "\",\n";
        f << "    \"year\": " << books[i].year << ",\n";
        f << "    \"author\": {\n";
        f << "      \"name\": \"" << books[i].author.name << "\",\n";
        f << "      \"country\": \"" << books[i].author.country << "\"\n";
        f << "    }\n";
        f << "  }";
        if (i < books.size() - 1) f << ",";
        f << "\n";
    }
    f << "]";
    f.close();
}

// -----------------------------
// Функция сохранения в CSV
// -----------------------------
void saveCSV(const vector<Book>& books) {
    ofstream f("out/data.csv", ios::out | ios::trunc);
    f << "id,title,year,author_name,author_country\n";
    for (const auto& b : books) {
        f << b.id << ",";
        f << "\"" << b.title << "\",";
        f << b.year << ",";
        f << "\"" << b.author.name << "\",";
        f << "\"" << b.author.country << "\"\n";
    }
    f.close();
}

// -----------------------------
// Функция сохранения в XML
// -----------------------------
void saveXML(const vector<Book>& books) {
    ofstream f("out/data.xml", ios::out | ios::trunc);
    f << "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
    f << "<library>\n";
    for (const auto& b : books) {
        f << "  <book>\n";
        f << "    <id>" << b.id << "</id>\n";
        f << "    <title>" << b.title << "</title>\n";
        f << "    <year>" << b.year << "</year>\n";
        f << "    <author>\n";
        f << "      <name>" << b.author.name << "</name>\n";
        f << "      <country>" << b.author.country << "</country>\n";
        f << "    </author>\n";
        f << "  </book>\n";
    }
    f << "</library>\n";
    f.close();
}

// -----------------------------
// Функция сохранения в YAML
// -----------------------------
void saveYAML(const vector<Book>& books) {
    ofstream f("out/data.yaml", ios::out | ios::trunc);
    for (const auto& b : books) {
        f << "- id: " << b.id << "\n";
        f << "  title: " << b.title << "\n";
        f << "  year: " << b.year << "\n";
        f << "  author:\n";
        f << "    name: " << b.author.name << "\n";
        f << "    country: " << b.author.country << "\n";
    }
    f.close();
}

// -----------------------------
// Главная функция
// -----------------------------
int main() {
    setlocale(LC_ALL, "Russian");

    // Тестовые данные (аналог таблицы book, связанной с author)
    vector<Book> books = {
        {1, "Война и мир", 1869, {"Лев Толстой", "Россия"}},
        {2, "Преступление и наказание", 1866, {"Фёдор Достоевский", "Россия"}},
        {3, "Отцы и дети", 1862, {"Иван Тургенев", "Россия"}}
    };

    // Создание папки out
    filesystem::create_directory("out");

    // Сохранение данных в разные форматы
    saveJSON(books);
    saveCSV(books);
    saveXML(books);
    saveYAML(books);

    cout << "Файлы успешно созданы в папке 'out'!" << endl;
    return 0;
}
